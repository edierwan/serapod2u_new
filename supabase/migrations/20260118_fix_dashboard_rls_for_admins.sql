-- Fix Dashboard RLS for Super Admins-- Date: 2026-01-18-- Description: Allow Super Admins (Level 1) to view all data for the Executive Dashboard-- 1. Helper Function to check if user is Super AdminCREATE OR REPLACE FUNCTION public.is_super_admin()RETURNS booleanLANGUAGE plpgsqlSECURITY DEFINERSET search_path = publicAS $$DECLARE  v_role_level int;BEGIN  -- Try to get role level via role_code join  -- Assuming users.role_code links to roles.role_code  BEGIN    SELECT r.role_level INTO v_role_level    FROM public.users u    JOIN public.roles r ON u.role_code = r.role_code    WHERE u.id = auth.uid();  EXCEPTION WHEN OTHERS THEN    v_role_level := NULL;  END;    IF v_role_level IS NULL THEN    -- Fallback: Check if role_code is 'SA' (Super Admin) directly on user    -- This handles case where role_code is just a string 'SA' or join failed    RETURN EXISTS (      SELECT 1 FROM public.users       WHERE id = auth.uid() AND role_code = 'SA' -- 'SA' is standard code for Super Admin    );  END IF;  RETURN COALESCE(v_role_level = 1, false);END;$$;-- 2. Add Policies to OrdersDROP POLICY IF EXISTS "Super Admins can view all orders" ON public.orders;CREATE POLICY "Super Admins can view all orders"ON public.ordersFOR SELECTTO authenticatedUSING (  public.is_super_admin());-- 3. Add Policies to Order ItemsDROP POLICY IF EXISTS "Super Admins can view all order items" ON public.order_items;CREATE POLICY "Super Admins can view all order items"ON public.order_itemsFOR SELECTTO authenticatedUSING (  public.is_super_admin());-- 4. Add Policies to Organizations (Distributors list)DROP POLICY IF EXISTS "Super Admins can view all organizations" ON public.organizations;CREATE POLICY "Super Admins can view all organizations"ON public.organizationsFOR SELECTTO authenticatedUSING (  public.is_super_admin());-- 5. Add Policies to Documents matchesDROP POLICY IF EXISTS "Super Admins can view all documents" ON public.documents;CREATE POLICY "Super Admins can view all documents"ON public.documentsFOR SELECTTO authenticatedUSING (  public.is_super_admin());-- 6. Add Policies to GL Journals (for Financial Data)DROP POLICY IF EXISTS "Super Admins can view all journals" ON public.gl_journals;CREATE POLICY "Super Admins can view all journals"ON public.gl_journalsFOR SELECTTO authenticatedUSING (  public.is_super_admin());-- 7. Add Policies to GL AccountsDROP POLICY IF EXISTS "Super Admins can view all accounts" ON public.gl_accounts;CREATE POLICY "Super Admins can view all accounts"ON public.gl_accountsFOR SELECTTO authenticatedUSING (  public.is_super_admin());