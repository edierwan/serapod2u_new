{\rtf1\ansi\ansicpg1252\cocoartf2761
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fnil\fcharset0 Menlo-Regular;}
{\colortbl;\red255\green255\blue255;\red83\green83\blue83;\red24\green24\blue24;\red202\green202\blue202;
\red70\green137\blue204;\red167\green197\blue152;\red212\green212\blue212;\red36\green168\blue107;\red100\green117\blue135;
}
{\*\expandedcolortbl;;\cssrgb\c40000\c40000\c40000;\cssrgb\c12157\c12157\c12157;\cssrgb\c83137\c83137\c83137;
\cssrgb\c33725\c61176\c83922;\cssrgb\c70980\c80784\c65882;\cssrgb\c86275\c86275\c86275;\cssrgb\c14118\c70588\c49412;\cssrgb\c46667\c53333\c60000;
}
\paperw11900\paperh16840\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\deftab720
\pard\pardeftab720\partightenfactor0

\f0\fs26 \cf2 \cb3 \expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 -- 1/6: Support Chat Core (Enums + Tables)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- Safe to run first. No RLS yet.\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- ENUMS\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 do\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \strokec4  begin\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 create\cf4 \strokec4  type support_thread_status \cf5 \strokec5 as\cf4 \strokec4  enum \cf7 \strokec7 (\cf8 \strokec8 'open'\cf7 \strokec7 ,\cf8 \strokec8 'pending'\cf7 \strokec7 ,\cf8 \strokec8 'resolved'\cf7 \strokec7 ,\cf8 \strokec8 'closed'\cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\cb3 exception \cf5 \strokec5 when\cf4 \strokec4  duplicate_object \cf5 \strokec5 then\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 end\cf4 \strokec4  \cf6 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cf5 \cb3 \strokec5 do\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \strokec4  begin\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 create\cf4 \strokec4  type support_sender_type \cf5 \strokec5 as\cf4 \strokec4  enum \cf7 \strokec7 (\cf8 \strokec8 'user'\cf7 \strokec7 ,\cf8 \strokec8 'admin'\cf7 \strokec7 ,\cf8 \strokec8 'system'\cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\cb3 exception \cf5 \strokec5 when\cf4 \strokec4  duplicate_object \cf5 \strokec5 then\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 end\cf4 \strokec4  \cf6 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- SUPPORT THREADS\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf5 \strokec5 table\cf4 \strokec4  if \cf9 \strokec9 not\cf4 \strokec4  exists public\cf7 \strokec7 .\cf4 \strokec4 support_threads \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   id uuid \cf5 \strokec5 primary\cf4 \strokec4  key \cf5 \strokec5 default\cf4 \strokec4  gen_random_uuid\cf7 \strokec7 (),\cf4 \cb1 \strokec4 \
\cb3   created_by_user_id uuid \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 references\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 users\cf7 \strokec7 (\cf4 \strokec4 id\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 on\cf4 \strokec4  delete cascade\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   subject text \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   status support_thread_status \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 default\cf4 \strokec4  \cf8 \strokec8 'open'\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   priority text \cf5 \strokec5 default\cf4 \strokec4  \cf8 \strokec8 'normal'\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   assigned_admin_user_id uuid \cf5 \strokec5 references\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 users\cf7 \strokec7 (\cf4 \strokec4 id\cf7 \strokec7 ),\cf4 \cb1 \strokec4 \
\cb3   last_message_at timestamptz\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   last_message_preview text\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   user_deleted_at timestamptz\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   admin_deleted_at timestamptz\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   created_at timestamptz \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 default\cf4 \strokec4  now\cf7 \strokec7 (),\cf4 \cb1 \strokec4 \
\cb3   updated_at timestamptz \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 default\cf4 \strokec4  now\cf7 \strokec7 ()\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf7 \cb3 \strokec7 );\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  index if \cf9 \strokec9 not\cf4 \strokec4  exists idx_support_threads_user\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cf7 \strokec7 (\cf4 \strokec4 created_by_user_id\cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  index if \cf9 \strokec9 not\cf4 \strokec4  exists idx_support_threads_status\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cf7 \strokec7 (\cf4 \strokec4 status\cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- SUPPORT MESSAGES\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf5 \strokec5 table\cf4 \strokec4  if \cf9 \strokec9 not\cf4 \strokec4  exists public\cf7 \strokec7 .\cf4 \strokec4 support_messages \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   id uuid \cf5 \strokec5 primary\cf4 \strokec4  key \cf5 \strokec5 default\cf4 \strokec4  gen_random_uuid\cf7 \strokec7 (),\cf4 \cb1 \strokec4 \
\cb3   thread_id uuid \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 references\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cf7 \strokec7 (\cf4 \strokec4 id\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 on\cf4 \strokec4  delete cascade\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   sender_type support_sender_type \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   sender_user_id uuid \cf5 \strokec5 references\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 users\cf7 \strokec7 (\cf4 \strokec4 id\cf7 \strokec7 ),\cf4 \cb1 \strokec4 \
\cb3   body text \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   attachments jsonb \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 default\cf4 \strokec4  \cf8 \strokec8 '[]'\cf4 \strokec4 ::jsonb\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   is_deleted_by_user boolean \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 default\cf4 \strokec4  \cf5 \strokec5 false\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   created_at timestamptz \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 default\cf4 \strokec4  now\cf7 \strokec7 ()\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf7 \cb3 \strokec7 );\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  index if \cf9 \strokec9 not\cf4 \strokec4  exists idx_support_messages_thread\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages\cf7 \strokec7 (\cf4 \strokec4 thread_id\cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  index if \cf9 \strokec9 not\cf4 \strokec4  exists idx_support_messages_created\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages\cf7 \strokec7 (\cf4 \strokec4 created_at\cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- 2/6: Read receipts + updated_at triggers\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- READ RECEIPTS (per thread, per user)\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf5 \strokec5 table\cf4 \strokec4  if \cf9 \strokec9 not\cf4 \strokec4  exists public\cf7 \strokec7 .\cf4 \strokec4 support_thread_reads \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3   thread_id uuid \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 references\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cf7 \strokec7 (\cf4 \strokec4 id\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 on\cf4 \strokec4  delete cascade\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   user_id uuid \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 references\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 users\cf7 \strokec7 (\cf4 \strokec4 id\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 on\cf4 \strokec4  delete cascade\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   last_read_at timestamptz \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 default\cf4 \strokec4  now\cf7 \strokec7 (),\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 primary\cf4 \strokec4  key \cf7 \strokec7 (\cf4 \strokec4 thread_id\cf7 \strokec7 ,\cf4 \strokec4  user_id\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7 );\cf4 \cb1 \strokec4 \
\
\cf5 \cb3 \strokec5 create\cf4 \strokec4  index if \cf9 \strokec9 not\cf4 \strokec4  exists idx_support_thread_reads_user\cb1 \
\cb3   \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_thread_reads\cf7 \strokec7 (\cf4 \strokec4 user_id\cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- GENERIC updated_at TRIGGER FUNCTION\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf9 \strokec9 or\cf4 \strokec4  replace function public\cf7 \strokec7 .\cf4 \strokec4 set_updated_at\cf7 \strokec7 ()\cf4 \cb1 \strokec4 \
\cb3 returns trigger\cb1 \
\cb3 language plpgsql\cb1 \
\cf5 \cb3 \strokec5 as\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \cb1 \strokec4 \
\cb3 begin\cb1 \
\cb3   new\cf7 \strokec7 .\cf4 \strokec4 updated_at \cf9 \strokec9 =\cf4 \strokec4  now\cf7 \strokec7 ();\cf4 \cb1 \strokec4 \
\cb3   return new\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 end\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cf6 \cb3 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- ATTACH updated_at TRIGGER TO support_threads\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 do\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \strokec4  begin\cb1 \
\cb3   \cf5 \strokec5 create\cf4 \strokec4  trigger trg_support_threads_updated_at\cb1 \
\cb3   before update \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cb1 \
\cb3   \cf5 \strokec5 for\cf4 \strokec4  each row\cb1 \
\cb3   execute function public\cf7 \strokec7 .\cf4 \strokec4 set_updated_at\cf7 \strokec7 ();\cf4 \cb1 \strokec4 \
\cb3 exception \cf5 \strokec5 when\cf4 \strokec4  duplicate_object \cf5 \strokec5 then\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 end\cf4 \strokec4  \cf6 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- 3/6 FIXED: RLS using JWT role (no user_roles table)\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- CLEAN UP BROKEN POLICIES\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cb3 drop policy if exists "admins_full_access_threads" \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cb3 drop policy if exists "admins_full_access_messages" \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cb3 drop policy if exists "admins_full_access_reads" \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_thread_reads\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- ADMIN CHECK (JWT ROLE)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- Admin if jwt claim role = 'admin' or 'hq_admin'\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- Adjust values if your project uses different role names\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- SUPPORT THREADS (ADMIN)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 create\cf4 \strokec4  policy "admins_full_access_threads"\cb1 \
\cf5 \cb3 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cb1 \
\cf5 \cb3 \strokec5 for\cf4 \strokec4  \cf5 \strokec5 all\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 using\cf4 \strokec4  \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 (\cf4 \strokec4 auth\cf7 \strokec7 .\cf4 \strokec4 jwt\cf7 \strokec7 ()\cf4 \strokec4  \cf9 \strokec9 ->>\cf4 \strokec4  \cf8 \strokec8 'role'\cf7 \strokec7 )\cf4 \strokec4  \cf9 \strokec9 in\cf4 \strokec4  \cf7 \strokec7 (\cf8 \strokec8 'admin'\cf7 \strokec7 ,\cf8 \strokec8 'hq_admin'\cf7 \strokec7 ,\cf8 \strokec8 'power_user'\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7 );\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- SUPPORT MESSAGES (ADMIN)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 create\cf4 \strokec4  policy "admins_full_access_messages"\cb1 \
\cf5 \cb3 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages\cb1 \
\cf5 \cb3 \strokec5 for\cf4 \strokec4  \cf5 \strokec5 all\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 using\cf4 \strokec4  \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 (\cf4 \strokec4 auth\cf7 \strokec7 .\cf4 \strokec4 jwt\cf7 \strokec7 ()\cf4 \strokec4  \cf9 \strokec9 ->>\cf4 \strokec4  \cf8 \strokec8 'role'\cf7 \strokec7 )\cf4 \strokec4  \cf9 \strokec9 in\cf4 \strokec4  \cf7 \strokec7 (\cf8 \strokec8 'admin'\cf7 \strokec7 ,\cf8 \strokec8 'hq_admin'\cf7 \strokec7 ,\cf8 \strokec8 'power_user'\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7 );\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- READ RECEIPTS (ADMIN)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- =========================\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 create\cf4 \strokec4  policy "admins_full_access_reads"\cb1 \
\cf5 \cb3 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_thread_reads\cb1 \
\cf5 \cb3 \strokec5 for\cf4 \strokec4  \cf5 \strokec5 all\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 using\cf4 \strokec4  \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 (\cf4 \strokec4 auth\cf7 \strokec7 .\cf4 \strokec4 jwt\cf7 \strokec7 ()\cf4 \strokec4  \cf9 \strokec9 ->>\cf4 \strokec4  \cf8 \strokec8 'role'\cf7 \strokec7 )\cf4 \strokec4  \cf9 \strokec9 in\cf4 \strokec4  \cf7 \strokec7 (\cf8 \strokec8 'admin'\cf7 \strokec7 ,\cf8 \strokec8 'hq_admin'\cf7 \strokec7 ,\cf8 \strokec8 'power_user'\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7 );\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- 4/6: Auto update thread metadata + status transitions\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- FUNCTION: update thread on new message\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf9 \strokec9 or\cf4 \strokec4  replace function public\cf7 \strokec7 .\cf4 \strokec4 on_support_message_insert\cf7 \strokec7 ()\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 returns trigger\cb1 \
\cb3 language plpgsql\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 as\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 begin\cb1 \
\cb3   \cf2 \strokec2 -- Update thread last message info\cf4 \cb1 \strokec4 \
\cb3   update public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cb1 \
\cb3   set\cb1 \
\cb3     last_message_at \cf9 \strokec9 =\cf4 \strokec4  new\cf7 \strokec7 .\cf4 \strokec4 created_at\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3     last_message_preview \cf9 \strokec9 =\cf4 \strokec4  \cf9 \strokec9 left\cf7 \strokec7 (\cf4 \strokec4 new\cf7 \strokec7 .\cf4 \strokec4 body\cf7 \strokec7 ,\cf4 \strokec4  \cf6 \strokec6 120\cf7 \strokec7 ),\cf4 \cb1 \strokec4 \
\
\cb3     \cf2 \strokec2 -- Status logic:\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 -- user sends -> open\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 -- admin sends -> pending\cf4 \cb1 \strokec4 \
\cb3     status \cf9 \strokec9 =\cf4 \strokec4  \cf5 \strokec5 case\cf4 \cb1 \strokec4 \
\cb3       \cf5 \strokec5 when\cf4 \strokec4  new\cf7 \strokec7 .\cf4 \strokec4 sender_type \cf9 \strokec9 =\cf4 \strokec4  \cf8 \strokec8 'user'\cf4 \strokec4  \cf5 \strokec5 then\cf4 \strokec4  \cf8 \strokec8 'open'\cf4 \strokec4 ::support_thread_status\cb1 \
\cb3       \cf5 \strokec5 when\cf4 \strokec4  new\cf7 \strokec7 .\cf4 \strokec4 sender_type \cf9 \strokec9 =\cf4 \strokec4  \cf8 \strokec8 'admin'\cf4 \strokec4  \cf5 \strokec5 then\cf4 \strokec4  \cf8 \strokec8 'pending'\cf4 \strokec4 ::support_thread_status\cb1 \
\cb3       \cf5 \strokec5 else\cf4 \strokec4  status\cb1 \
\cb3     \cf5 \strokec5 end\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 where\cf4 \strokec4  id \cf9 \strokec9 =\cf4 \strokec4  new\cf7 \strokec7 .\cf4 \strokec4 thread_id\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cb3   return new\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 end\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf6 \cb3 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- TRIGGER: after insert on messages\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 do\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \strokec4  begin\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 create\cf4 \strokec4  trigger trg_support_message_insert\cb1 \
\cb3   after insert \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages\cb1 \
\cb3   \cf5 \strokec5 for\cf4 \strokec4  each row\cb1 \
\cb3   execute function public\cf7 \strokec7 .\cf4 \strokec4 on_support_message_insert\cf7 \strokec7 ();\cf4 \cb1 \strokec4 \
\cb3 exception \cf5 \strokec5 when\cf4 \strokec4  duplicate_object \cf5 \strokec5 then\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 end\cf4 \strokec4  \cf6 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- FUNCTION: auto-create read receipt for sender\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf9 \strokec9 or\cf4 \strokec4  replace function public\cf7 \strokec7 .\cf4 \strokec4 on_support_message_read_init\cf7 \strokec7 ()\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 returns trigger\cb1 \
\cb3 language plpgsql\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 as\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 begin\cb1 \
\cb3   insert \cf5 \strokec5 into\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_thread_reads \cf7 \strokec7 (\cf4 \strokec4 thread_id\cf7 \strokec7 ,\cf4 \strokec4  user_id\cf7 \strokec7 ,\cf4 \strokec4  last_read_at\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cb3   values \cf7 \strokec7 (\cf4 \strokec4 new\cf7 \strokec7 .\cf4 \strokec4 thread_id\cf7 \strokec7 ,\cf4 \strokec4  new\cf7 \strokec7 .\cf4 \strokec4 sender_user_id\cf7 \strokec7 ,\cf4 \strokec4  now\cf7 \strokec7 ())\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 on\cf4 \strokec4  conflict \cf7 \strokec7 (\cf4 \strokec4 thread_id\cf7 \strokec7 ,\cf4 \strokec4  user_id\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 do\cf4 \strokec4  update set last_read_at \cf9 \strokec9 =\cf4 \strokec4  excluded\cf7 \strokec7 .\cf4 \strokec4 last_read_at\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cb3   return new\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 end\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf6 \cb3 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- TRIGGER: mark sender as read immediately\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 do\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \strokec4  begin\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 create\cf4 \strokec4  trigger trg_support_message_read_init\cb1 \
\cb3   after insert \cf5 \strokec5 on\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages\cb1 \
\cb3   \cf5 \strokec5 for\cf4 \strokec4  each row\cb1 \
\cb3   \cf5 \strokec5 when\cf4 \strokec4  \cf7 \strokec7 (\cf4 \strokec4 new\cf7 \strokec7 .\cf4 \strokec4 sender_user_id \cf9 \strokec9 is\cf4 \strokec4  \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cb3   execute function public\cf7 \strokec7 .\cf4 \strokec4 on_support_message_read_init\cf7 \strokec7 ();\cf4 \cb1 \strokec4 \
\cb3 exception \cf5 \strokec5 when\cf4 \strokec4  duplicate_object \cf5 \strokec5 then\cf4 \strokec4  \cf9 \strokec9 null\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 end\cf4 \strokec4  \cf6 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- 5/6: Unread count + inbox helper views\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- =========================================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- VIEW: unread message count per thread/user\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- =========================================\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf9 \strokec9 or\cf4 \strokec4  replace view public\cf7 \strokec7 .\cf4 \strokec4 v_support_thread_unread_counts \cf5 \strokec5 as\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 select\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   t\cf7 \strokec7 .\cf4 \strokec4 id \cf5 \strokec5 as\cf4 \strokec4  thread_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   u\cf7 \strokec7 .\cf4 \strokec4 id \cf5 \strokec5 as\cf4 \strokec4  user_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   count\cf7 \strokec7 (\cf4 \strokec4 m\cf7 \strokec7 .\cf4 \strokec4 id\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 as\cf4 \strokec4  unread_count\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 from\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads t\cb1 \
\pard\pardeftab720\partightenfactor0
\cf9 \cb3 \strokec9 join\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 users u\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 -- user sees own threads\cf4 \cb1 \strokec4 \
\cb3     u\cf7 \strokec7 .\cf4 \strokec4 id \cf9 \strokec9 =\cf4 \strokec4  t\cf7 \strokec7 .\cf4 \strokec4 created_by_user_id\cb1 \
\cb3     \cf9 \strokec9 or\cf4 \strokec4  \cf7 \strokec7 (\cf4 \strokec4 auth\cf7 \strokec7 .\cf4 \strokec4 jwt\cf7 \strokec7 ()\cf4 \strokec4  \cf9 \strokec9 ->>\cf4 \strokec4  \cf8 \strokec8 'role'\cf7 \strokec7 )\cf4 \strokec4  \cf9 \strokec9 in\cf4 \strokec4  \cf7 \strokec7 (\cf8 \strokec8 'admin'\cf7 \strokec7 ,\cf8 \strokec8 'hq_admin'\cf7 \strokec7 ,\cf8 \strokec8 'power_user'\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf9 \cb3 \strokec9 left\cf4 \strokec4  \cf9 \strokec9 join\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_thread_reads r\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  r\cf7 \strokec7 .\cf4 \strokec4 thread_id \cf9 \strokec9 =\cf4 \strokec4  t\cf7 \strokec7 .\cf4 \strokec4 id\cb1 \
\cb3  \cf9 \strokec9 and\cf4 \strokec4  r\cf7 \strokec7 .\cf4 \strokec4 user_id \cf9 \strokec9 =\cf4 \strokec4  u\cf7 \strokec7 .\cf4 \strokec4 id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf9 \cb3 \strokec9 join\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages m\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  m\cf7 \strokec7 .\cf4 \strokec4 thread_id \cf9 \strokec9 =\cf4 \strokec4  t\cf7 \strokec7 .\cf4 \strokec4 id\cb1 \
\cb3  \cf9 \strokec9 and\cf4 \strokec4  m\cf7 \strokec7 .\cf4 \strokec4 created_at \cf9 \strokec9 >\cf4 \strokec4  coalesce\cf7 \strokec7 (\cf4 \strokec4 r\cf7 \strokec7 .\cf4 \strokec4 last_read_at\cf7 \strokec7 ,\cf4 \strokec4  \cf8 \strokec8 'epoch'\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cb3  \cf9 \strokec9 and\cf4 \strokec4  m\cf7 \strokec7 .\cf4 \strokec4 sender_user_id \cf9 \strokec9 is\cf4 \strokec4  \cf5 \strokec5 distinct\cf4 \strokec4  \cf5 \strokec5 from\cf4 \strokec4  u\cf7 \strokec7 .\cf4 \strokec4 id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 group\cf4 \strokec4  by t\cf7 \strokec7 .\cf4 \strokec4 id\cf7 \strokec7 ,\cf4 \strokec4  u\cf7 \strokec7 .\cf4 \strokec4 id\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- =========================================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- VIEW: user inbox (thread list)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- =========================================\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf9 \strokec9 or\cf4 \strokec4  replace view public\cf7 \strokec7 .\cf4 \strokec4 v_support_user_inbox \cf5 \strokec5 as\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 select\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   t\cf7 \strokec7 .\cf4 \strokec4 id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 subject\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 status\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 priority\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 last_message_at\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 last_message_preview\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   coalesce\cf7 \strokec7 (\cf4 \strokec4 u\cf7 \strokec7 .\cf4 \strokec4 unread_count\cf7 \strokec7 ,\cf4 \strokec4  \cf6 \strokec6 0\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 as\cf4 \strokec4  unread_count\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 created_at\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 from\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads t\cb1 \
\pard\pardeftab720\partightenfactor0
\cf9 \cb3 \strokec9 left\cf4 \strokec4  \cf9 \strokec9 join\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 v_support_thread_unread_counts u\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  u\cf7 \strokec7 .\cf4 \strokec4 thread_id \cf9 \strokec9 =\cf4 \strokec4  t\cf7 \strokec7 .\cf4 \strokec4 id\cb1 \
\cb3  \cf9 \strokec9 and\cf4 \strokec4  u\cf7 \strokec7 .\cf4 \strokec4 user_id \cf9 \strokec9 =\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 uid\cf7 \strokec7 ()\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 where\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   t\cf7 \strokec7 .\cf4 \strokec4 created_by_user_id \cf9 \strokec9 =\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 uid\cf7 \strokec7 ()\cf4 \cb1 \strokec4 \
\cb3   \cf9 \strokec9 and\cf4 \strokec4  t\cf7 \strokec7 .\cf4 \strokec4 user_deleted_at \cf9 \strokec9 is\cf4 \strokec4  \cf9 \strokec9 null\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 order\cf4 \strokec4  by t\cf7 \strokec7 .\cf4 \strokec4 last_message_at \cf5 \strokec5 desc\cf4 \strokec4  nulls last\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- =========================================\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- VIEW: admin inbox (thread list)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 -- =========================================\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf9 \strokec9 or\cf4 \strokec4  replace view public\cf7 \strokec7 .\cf4 \strokec4 v_support_admin_inbox \cf5 \strokec5 as\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 select\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   t\cf7 \strokec7 .\cf4 \strokec4 id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 subject\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 status\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 priority\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 created_by_user_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 assigned_admin_user_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 last_message_at\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 last_message_preview\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   count\cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 case\cf4 \cb1 \strokec4 \
\cb3       \cf5 \strokec5 when\cf4 \strokec4  r\cf7 \strokec7 .\cf4 \strokec4 last_read_at \cf9 \strokec9 is\cf4 \strokec4  \cf9 \strokec9 null\cf4 \cb1 \strokec4 \
\cb3         \cf9 \strokec9 or\cf4 \strokec4  m\cf7 \strokec7 .\cf4 \strokec4 created_at \cf9 \strokec9 >\cf4 \strokec4  r\cf7 \strokec7 .\cf4 \strokec4 last_read_at\cb1 \
\cb3       \cf5 \strokec5 then\cf4 \strokec4  \cf6 \strokec6 1\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 end\cf4 \cb1 \strokec4 \
\cb3   \cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 as\cf4 \strokec4  unread_count\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 created_at\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 from\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads t\cb1 \
\pard\pardeftab720\partightenfactor0
\cf9 \cb3 \strokec9 left\cf4 \strokec4  \cf9 \strokec9 join\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_thread_reads r\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  r\cf7 \strokec7 .\cf4 \strokec4 thread_id \cf9 \strokec9 =\cf4 \strokec4  t\cf7 \strokec7 .\cf4 \strokec4 id\cb1 \
\cb3  \cf9 \strokec9 and\cf4 \strokec4  r\cf7 \strokec7 .\cf4 \strokec4 user_id \cf9 \strokec9 =\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 uid\cf7 \strokec7 ()\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf9 \cb3 \strokec9 left\cf4 \strokec4  \cf9 \strokec9 join\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages m\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf5 \strokec5 on\cf4 \strokec4  m\cf7 \strokec7 .\cf4 \strokec4 thread_id \cf9 \strokec9 =\cf4 \strokec4  t\cf7 \strokec7 .\cf4 \strokec4 id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 where\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   \cf7 \strokec7 (\cf4 \strokec4 auth\cf7 \strokec7 .\cf4 \strokec4 jwt\cf7 \strokec7 ()\cf4 \strokec4  \cf9 \strokec9 ->>\cf4 \strokec4  \cf8 \strokec8 'role'\cf7 \strokec7 )\cf4 \strokec4  \cf9 \strokec9 in\cf4 \strokec4  \cf7 \strokec7 (\cf8 \strokec8 'admin'\cf7 \strokec7 ,\cf8 \strokec8 'hq_admin'\cf7 \strokec7 ,\cf8 \strokec8 'power_user'\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 group\cf4 \strokec4  by\cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   t\cf7 \strokec7 .\cf4 \strokec4 id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 subject\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 status\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 priority\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 created_by_user_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 assigned_admin_user_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 last_message_at\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 last_message_preview\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   t\cf7 \strokec7 .\cf4 \strokec4 created_at\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 order\cf4 \strokec4  by t\cf7 \strokec7 .\cf4 \strokec4 last_message_at \cf5 \strokec5 desc\cf4 \strokec4  nulls last\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- FIX for 6/6: ONLY announcements logic (no trigger disabling)\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 -- SYSTEM ANNOUNCEMENTS THREAD (PER USER)\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf9 \strokec9 or\cf4 \strokec4  replace function public\cf7 \strokec7 .\cf4 \strokec4 get_or_create_announcement_thread\cf7 \strokec7 (\cf4 \strokec4 p_user_id uuid\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 returns uuid\cb1 \
\cb3 language plpgsql\cb1 \
\cb3 security definer\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 as\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 declare\cb1 \
\cb3   v_thread_id uuid\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cb3 begin\cb1 \
\cb3   \cf5 \strokec5 select\cf4 \strokec4  id\cb1 \
\cb3     \cf5 \strokec5 into\cf4 \strokec4  v_thread_id\cb1 \
\cb3   \cf5 \strokec5 from\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads\cb1 \
\cb3   \cf5 \strokec5 where\cf4 \strokec4  created_by_user_id \cf9 \strokec9 =\cf4 \strokec4  p_user_id\cb1 \
\cb3     \cf9 \strokec9 and\cf4 \strokec4  subject \cf9 \strokec9 =\cf4 \strokec4  \cf8 \strokec8 'Announcements'\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 limit\cf4 \strokec4  \cf6 \strokec6 1\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cb3   if v_thread_id \cf9 \strokec9 is\cf4 \strokec4  \cf9 \strokec9 null\cf4 \strokec4  \cf5 \strokec5 then\cf4 \cb1 \strokec4 \
\cb3     insert \cf5 \strokec5 into\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_threads \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3       created_by_user_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       subject\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       status\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       priority\cb1 \
\cb3     \cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cb3     values \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3       p_user_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       \cf8 \strokec8 'Announcements'\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       \cf8 \strokec8 'open'\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       \cf8 \strokec8 'normal'\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 returning\cf4 \strokec4  id \cf5 \strokec5 into\cf4 \strokec4  v_thread_id\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 end\cf4 \strokec4  if\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cb3   return v_thread_id\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 end\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf6 \cb3 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 revoke \cf5 \strokec5 all\cf4 \strokec4  \cf5 \strokec5 on\cf4 \strokec4  function public\cf7 \strokec7 .\cf4 \strokec4 get_or_create_announcement_thread\cf7 \strokec7 (\cf4 \strokec4 uuid\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 from\cf4 \strokec4  public\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 grant\cf4 \strokec4  execute \cf5 \strokec5 on\cf4 \strokec4  function public\cf7 \strokec7 .\cf4 \strokec4 get_or_create_announcement_thread\cf7 \strokec7 (\cf4 \strokec4 uuid\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 to\cf4 \strokec4  authenticated\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 -- ADMIN BLAST FUNCTION\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 create\cf4 \strokec4  \cf9 \strokec9 or\cf4 \strokec4  replace function public\cf7 \strokec7 .\cf4 \strokec4 admin_blast_message\cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3   p_message text\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3   p_attachments jsonb \cf5 \strokec5 default\cf4 \strokec4  \cf8 \strokec8 '[]'\cf4 \strokec4 ::jsonb\cb1 \
\pard\pardeftab720\partightenfactor0
\cf7 \cb3 \strokec7 )\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 returns void\cb1 \
\cb3 language plpgsql\cb1 \
\cb3 security definer\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 as\cf4 \strokec4  \cf6 \strokec6 $$\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 declare\cb1 \
\cb3   u record\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cb3   v_thread_id uuid\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cb3 begin\cb1 \
\cb3   if \cf7 \strokec7 (\cf4 \strokec4 auth\cf7 \strokec7 .\cf4 \strokec4 jwt\cf7 \strokec7 ()\cf4 \strokec4  \cf9 \strokec9 ->>\cf4 \strokec4  \cf8 \strokec8 'role'\cf7 \strokec7 )\cf4 \strokec4  \cf9 \strokec9 not\cf4 \strokec4  \cf9 \strokec9 in\cf4 \strokec4  \cf7 \strokec7 (\cf8 \strokec8 'admin'\cf7 \strokec7 ,\cf8 \strokec8 'hq_admin'\cf7 \strokec7 ,\cf8 \strokec8 'power_user'\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 then\cf4 \cb1 \strokec4 \
\cb3     raise exception \cf8 \strokec8 'Not authorized'\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 end\cf4 \strokec4  if\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\cb3   \cf5 \strokec5 for\cf4 \strokec4  u \cf9 \strokec9 in\cf4 \strokec4  \cf5 \strokec5 select\cf4 \strokec4  id \cf5 \strokec5 from\cf4 \strokec4  auth\cf7 \strokec7 .\cf4 \strokec4 users loop\cb1 \
\cb3     v_thread_id :\cf9 \strokec9 =\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 get_or_create_announcement_thread\cf7 \strokec7 (\cf4 \strokec4 u\cf7 \strokec7 .\cf4 \strokec4 id\cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\
\cb3     insert \cf5 \strokec5 into\cf4 \strokec4  public\cf7 \strokec7 .\cf4 \strokec4 support_messages \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3       thread_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       sender_type\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       sender_user_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       body\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       attachments\cb1 \
\cb3     \cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cb3     values \cf7 \strokec7 (\cf4 \cb1 \strokec4 \
\cb3       v_thread_id\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       \cf8 \strokec8 'system'\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       \cf9 \strokec9 null\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       p_message\cf7 \strokec7 ,\cf4 \cb1 \strokec4 \
\cb3       p_attachments\cb1 \
\cb3     \cf7 \strokec7 );\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 end\cf4 \strokec4  loop\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 end\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf6 \cb3 \strokec6 $$\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 revoke \cf5 \strokec5 all\cf4 \strokec4  \cf5 \strokec5 on\cf4 \strokec4  function public\cf7 \strokec7 .\cf4 \strokec4 admin_blast_message\cf7 \strokec7 (\cf4 \strokec4 text\cf7 \strokec7 ,\cf4 \strokec4  jsonb\cf7 \strokec7 )\cf4 \strokec4  \cf5 \strokec5 from\cf4 \strokec4  public\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 grant\cf4 \strokec4  execute \cf5 \strokec5 on\cf4 \strokec4  function public\cf7 \strokec7 .\cf4 \strokec4 admin_blast_message\cf7 \strokec7 (\cf4 \strokec4 text\cf7 \strokec7 ,\cf4 \strokec4  jsonb\cf7 \strokec7 )\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 to\cf4 \strokec4  authenticated\cf7 \strokec7 ;\cf4 \cb1 \strokec4 \
\
}