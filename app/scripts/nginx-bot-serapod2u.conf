# ─────────────────────────────────────────────────────────────────
# bot.serapod2u.com — Moltbot health + Ollama auth proxy
# ─────────────────────────────────────────────────────────────────

# Rate limiting zone for Ollama proxy (10 req/min per IP)
limit_req_zone $binary_remote_addr zone=ollama_limit:10m rate=10r/m;

server {
    server_name bot.serapod2u.com;

    # ── Moltbot health (existing) ──────────────────────────────────
    location /health {
        proxy_pass http://127.0.0.1:4000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ── Ollama authenticated proxy ─────────────────────────────────
    # ONLY accessible with the correct x-ollama-key header.
    # Ollama itself stays bound to 127.0.0.1:11434 (not exposed).
    location /ollama/ {
        # ── Token authentication ───────────────────────────────────
        set $expected_token "66f33cf7be52ad0e2d85dfe5dc2c90e494ec34016f8861d1e8e0d90f7ae07ff2";
        if ($http_x_ollama_key != $expected_token) {
            return 401 '{"error":"unauthorized"}';
        }

        # ── Rate limiting ──────────────────────────────────────────
        limit_req zone=ollama_limit burst=5 nodelay;

        # ── Proxy to localhost Ollama ──────────────────────────────
        rewrite ^/ollama/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:11434;
        proxy_http_version 1.1;

        proxy_set_header Host 127.0.0.1:11434;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Ollama can be slow on small VPS (model loading)
        proxy_connect_timeout 30s;
        proxy_read_timeout 120s;
        proxy_send_timeout 120s;

        # Limit request body size (AI prompts)
        client_max_body_size 1m;
    }

    # ── Default catch-all ──────────────────────────────────────────
    location / {
        return 404;
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/bot.serapod2u.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/bot.serapod2u.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = bot.serapod2u.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    server_name bot.serapod2u.com;
    listen 80;
    return 404; # managed by Certbot
}
